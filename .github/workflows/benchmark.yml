name: Benchmark
on:
  status:
  workflow_dispatch:

jobs:
  benchmark:
    runs-on: ubuntu-latest
    # Only run on successful buildbot builds
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.state == 'success' &&
       github.event.context == 'buildbot/nix-build')
    steps:
      - uses: actions/checkout@v6
        with:
          # For status events, checkout the commit the status was reported on
          ref: ${{ github.event.sha || github.sha }}

      - uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: |
            extra-substituters = https://cache.thalheim.io/
            extra-trusted-public-keys = cache.thalheim.io-1:R7msbosLEZKrxk/lKxf9BTjOOH7Ax3H0Qj0/6wiHOgc=

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install Bencher CLI
        uses: bencherdev/bencher@main

      - name: Run benchmark
        run: |
          bencher run \
            --project harmonia \
            --token '${{ secrets.BENCHER_API_TOKEN }}' \
            --branch '${{ github.event.branches[0].name || github.ref_name }}' \
            --hash '${{ github.event.sha || github.sha }}' \
            --testbed github-actions \
            --adapter rust_criterion \
            --github-actions '${{ secrets.GITHUB_TOKEN }}' \
            --err \
            'cargo bench --package harmonia-bench'
        env:
          HARMONIA_FLAKE: .#harmonia
